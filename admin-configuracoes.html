<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Orchestra Admin</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body class="admin-body">
    <script>
        // Verifica√ß√£o de autentica√ß√£o
        const isLogged = localStorage.getItem('admin_logged');
        const userEmail = localStorage.getItem('admin_email');
        
        console.log('üîê Verificando auth:', { isLogged, userEmail });
        
        if (!isLogged || !userEmail) {
            console.log('‚ùå N√£o autenticado - redirecionando...');
            window.location.replace('admin-login.html');
        } else {
            console.log('‚úÖ Usu√°rio autenticado:', userEmail);
        }
        
        // Fun√ß√£o de logout
        function fazerLogout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.clear();
                console.log('üö™ Logout realizado');
                window.location.href = 'admin-login.html';
            }
        }
    </script>

    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <div class="logo-placeholder">ORCHESTRA</div>
            <span class="admin-badge">Admin</span>
        </div>

        <nav class="sidebar-nav">
            <a href="admin-dashboard.html" class="sidebar-link">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <rect x="3" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="11" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="3" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <rect x="11" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                Dashboard
            </a>

            <a href="admin-ebooks.html" class="sidebar-link">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M4 2H12C12.55 2 13 2.45 13 3V14L8 11L3 14V3C3 2.45 3.45 2 4 2Z" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                Ebooks
            </a>

            <a href="admin-partituras.html" class="sidebar-link">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <rect x="4" y="3" width="12" height="14" rx="1" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M8 7H12M8 10H12M8 13H10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Partituras
            </a>

            <a href="admin-usuarios.html" class="sidebar-link">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <circle cx="10" cy="7" r="3" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M5 17C5 14 7 12 10 12C13 12 15 14 15 17" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                Usu√°rios
            </a>

            <a href="admin-configuracoes.html" class="sidebar-link active">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 7V10M10 13H10.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
                Configura√ß√µes
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="index.html" class="sidebar-link">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M3 7L10 3L17 7V16H3V7Z" stroke="currentColor" stroke-width="1.5"/>
                </svg>
                Ver Site
            </a>
            <a href="javascript:void(0)" class="sidebar-link" onclick="fazerLogout()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M7 3H3V17H7M13 13L17 10L13 7M17 10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Sair
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-left">
                <h1 class="page-title">Configura√ß√µes</h1>
                <p class="page-subtitle">Gerencie suas prefer√™ncias e seguran√ßa</p>
            </div>
        </header>

        <section style="padding: 32px;">
            <div style="max-width: 800px;">
                <!-- Perfil -->
                <div class="content-box" style="margin-bottom: 24px;">
                    <h2 class="content-title">Informa√ß√µes do Perfil</h2>
                    <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 700;" id="avatarLetter">
                            A
                        </div>
                        <div>
                            <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;" id="userName">Carregando...</h3>
                            <p style="color: #666;" id="userEmail">Carregando...</p>
                            <p style="color: #666; font-size: 14px;"><span class="table-badge badge-purple" id="userRole">Admin</span></p>
                        </div>
                    </div>
                </div>

                <!-- Seguran√ßa -->
                <div class="content-box" style="margin-bottom: 24px;">
                    <h2 class="content-title">Seguran√ßa</h2>
                    <form id="changePasswordForm" style="max-width: 500px;">
                        <div class="form-group">
                            <label class="form-label">Senha Atual</label>
                            <input type="password" id="senhaAtual" class="form-input" placeholder="Digite sua senha atual" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nova Senha</label>
                            <input type="password" id="novaSenha" class="form-input" placeholder="M√≠nimo 6 caracteres" required minlength="6">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Confirmar Nova Senha</label>
                            <input type="password" id="confirmarSenha" class="form-input" placeholder="Digite novamente" required minlength="6">
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <rect x="5" y="7" width="6" height="7" rx="1" stroke="currentColor" stroke-width="1.5"/>
                                <path d="M6 7V4.5C6 3.11929 7.11929 2 8.5 2C9.88071 2 11 3.11929 11 4.5V7" stroke="currentColor" stroke-width="1.5"/>
                            </svg>
                            Alterar Senha
                        </button>
                    </form>
                </div>

                <!-- Sobre o Sistema -->
                <div class="content-box">
                    <h2 class="content-title">Sobre o Sistema</h2>
                    <p style="color: #666; line-height: 1.6; margin-bottom: 16px;">
                        <strong>Orchestra Music Platform</strong><br>
                        Vers√£o 1.0.0<br>
                        Sistema de gerenciamento de cursos e partituras musicais
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <span class="table-badge badge-green">‚úì Backend Online</span>
                        <span class="table-badge badge-blue">‚úì Supabase Conectado</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ========================================
        // CARREGAR DADOS DO USU√ÅRIO
        // ========================================
        function carregarDadosUsuario() {
            const userName = localStorage.getItem('admin_user_name');
            const userEmail = localStorage.getItem('admin_email');
            const userRole = localStorage.getItem('admin_user_role');

            if (userName) {
                document.getElementById('avatarLetter').textContent = userName.charAt(0).toUpperCase();
                document.getElementById('userName').textContent = userName;
            }
            
            if (userEmail) {
                document.getElementById('userEmail').textContent = userEmail;
            }
            
            if (userRole) {
                document.getElementById('userRole').textContent = userRole === 'admin' ? 'Administrador' : 'Usu√°rio';
            }
        }

        // ========================================
        // ALTERAR SENHA
        // ========================================
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarSenha = document.getElementById('confirmarSenha').value;
            const userId = localStorage.getItem('admin_user_id');
            const userEmail = localStorage.getItem('admin_email');

            if (novaSenha !== confirmarSenha) {
                alert('‚ùå As senhas n√£o coincidem!');
                return;
            }

            if (novaSenha.length < 6) {
                alert('‚ùå A senha deve ter no m√≠nimo 6 caracteres');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.innerHTML;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = 'Alterando...';

                // Hash da senha atual
                const encoder = new TextEncoder();
                const data1 = encoder.encode(senhaAtual);
                const hashBuffer1 = await crypto.subtle.digest('SHA-256', data1);
                const hashArray1 = Array.from(new Uint8Array(hashBuffer1));
                const senhaAtualHash = hashArray1.map(b => b.toString(16).padStart(2, '0')).join('');

                // Buscar usu√°rio para verificar senha atual
                const { data: usuario, error: errorBusca } = await supabase
                    .from('users')
                    .select('senha')
                    .eq('id', userId)
                    .single();

                if (errorBusca || !usuario) {
                    throw new Error('Erro ao buscar usu√°rio');
                }

                // Verificar senha atual
                if (usuario.senha !== senhaAtualHash) {
                    throw new Error('Senha atual incorreta');
                }

                // Hash da nova senha
                const data2 = encoder.encode(novaSenha);
                const hashBuffer2 = await crypto.subtle.digest('SHA-256', data2);
                const hashArray2 = Array.from(new Uint8Array(hashBuffer2));
                const novaSenhaHash = hashArray2.map(b => b.toString(16).padStart(2, '0')).join('');

                // Atualizar senha
                const { error: errorUpdate } = await supabase
                    .from('users')
                    .update({ 
                        senha: novaSenhaHash,
                        senha_temporaria: false
                    })
                    .eq('id', userId);

                if (errorUpdate) throw errorUpdate;

                alert('‚úÖ Senha alterada com sucesso!');
                document.getElementById('changePasswordForm').reset();
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = btnText;
            }
        });

        // ========================================
        // INICIALIZAR
        // ========================================
        carregarDadosUsuario();
    </script>
</body>
</html>
